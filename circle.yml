machine:
  timezone: Europe/London
  python:
    version: 2.7.12
  node:
    version: 6.4.0
  pre:
    - sudo apt-get -y install rpm libsasl2-dev libldap2-dev libssl-dev
    - sudo mkdir -p /opt/cantemo/portal/portal/plugins
    - sudo chown ubuntu /opt/cantemo/portal/portal/plugins
  environment:
    PYTHONPATH: ${PYTHONPATH}:deps/gnmvidispine

dependencies:
  override:
    - npm install
    - pip install -r test-requirements.txt
  cache_directories:
    - node_modules
    - "/home/ubuntu/.cache/pip"

checkout:
  post:
    - git submodule sync
    - git submodule update --init
    - for dir in `find portal/plugins  -maxdepth 1 -mindepth 1 -type d | grep -v -E '^\.'`; do echo Symlinking ${dir} to build locations; ln -s ${PWD}/$dir /opt/cantemo/portal/portal/plugins;done
    - for dir in `find portal/plugins  -maxdepth 1 -mindepth 1 -type d | grep -v -E '^\.'`; do echo Trying to run "${PWD}/$dir/testsetup.sh"; if [ -x "${PWD}/$dir/testsetup.sh" ]; then ${PWD}/$dir/testsetup.sh; fi; done
    - touch portal/__init__.py
    - touch portal/plugins/__init__.py

test:
  override:
    - DJANGO_SETTINGS_MODULE=portal.plugins.gnmatomresponder.tests.django_test_settings nosetests -v portal/plugins/gnmatomresponder/tests
    - npm run test
    - npm run testcss

deployment:
  master:
    branch: /.*/
    commands:
      #these are needed for testing, but supplied by the real system when deployed. if we include them in the build
      #then it will break portal when installed!
      - rm -f portal/__init__.py; rm -f portal/plugins/__init__.py
      - sudo mkdir -p /opt/cantemo/portal/portal/plugins; sudo chown -R ubuntu /opt/cantemo
      - chmod a+x buildrpms.sh
      - ./buildrpms.sh
      - for x in `ls ${HOME}/rpmbuild/RPMS/noarch/*.rpm`; do aws s3 cp "$x" s3://gnm-multimedia-deployables/gnm_portal_plugins/portal_plugins_public/${CIRCLE_BUILD_NUM}/`basename $x` --acl public-read; done